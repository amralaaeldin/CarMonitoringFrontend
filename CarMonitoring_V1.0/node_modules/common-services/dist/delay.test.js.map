{"version":3,"sources":["../src/delay.test.ts"],"names":["describe","log","sinon","stub","beforeEach","reset","test","delay","service","create","clear","dispose","assert","deepEqual","args","setTimeoutStub","global","afterEach","restore","delayPromise","returns","equal","length","clearTimeoutStub","Promise","resolve","catch","err","code","all","Knifecycle","register","initDelayService","run"],"mappings":"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","sourcesContent":["/* eslint max-nested-callbacks:0 */\nimport assert from 'assert';\nimport sinon from 'sinon';\nimport Knifecycle, { constant } from 'knifecycle';\nimport initDelayService from './delay';\n\ndescribe('initDelayService', () => {\n  const log = sinon.stub();\n\n  beforeEach(() => {\n    log.reset();\n  });\n\n  test('should work', async () => {\n    const delay = await initDelayService({\n      log,\n    });\n\n    assert('function' === typeof delay.service.create);\n    assert('function' === typeof delay.service.clear);\n    assert('function' === typeof delay.dispose);\n    assert.deepEqual(log.args, [['debug', '⌛ - Delay service initialized.']]);\n  });\n\n  describe('delay.create', () => {\n    let setTimeoutStub;\n\n    beforeEach(() => {\n      setTimeoutStub = sinon.stub(global, 'setTimeout');\n    });\n\n    afterEach(() => {\n      setTimeoutStub.restore();\n    });\n\n    test('should work', async () => {\n      const { service: delay } = await initDelayService({\n        log,\n      });\n\n      let delayPromise;\n\n      log.reset();\n      setTimeoutStub.returns({});\n\n      delayPromise = delay.create(1000);\n      assert.equal(setTimeoutStub.args.length, 1);\n      assert.equal(setTimeoutStub.args[0][1], 1000);\n      assert.deepEqual(log.args, [['debug', '⏳ - Created a delay:', 1000]]);\n      // Run set callback\n      setTimeoutStub.args[0][0]();\n\n      await delayPromise;\n    });\n  });\n\n  describe('delay.clear', () => {\n    let setTimeoutStub;\n    let clearTimeoutStub;\n\n    beforeEach(() => {\n      setTimeoutStub = sinon.stub(global, 'setTimeout');\n      clearTimeoutStub = sinon.stub(global, 'clearTimeout');\n      setTimeoutStub.returns({});\n    });\n\n    afterEach(() => {\n      setTimeoutStub.restore();\n      clearTimeoutStub.restore();\n    });\n\n    test('should fail with bad promise', async () => {\n      const { service: delay } = await initDelayService({\n        log,\n      });\n\n      log.reset();\n\n      await delay.clear(Promise.resolve()).catch((err) => {\n        assert.equal(err.code, 'E_BAD_DELAY');\n      });\n    });\n\n    test('should work', async () => {\n      const { service: delay } = await initDelayService({\n        log,\n      });\n      const delayPromise = delay.create(10000);\n\n      await Promise.resolve();\n\n      log.reset();\n\n      await Promise.all([\n        delay.clear(delayPromise),\n        delayPromise.catch((err) => {\n          assert.equal(err.code, 'E_DELAY_CLEARED');\n        }),\n      ]);\n      assert.deepEqual(log.args, [['debug', '⏳ - Cleared a delay']]);\n    });\n  });\n\n  test('should work with Knifecycle', async () => {\n    const { delay } = await new Knifecycle()\n      .register(initDelayService)\n      .register(constant('log', log))\n      .run(['delay']);\n\n    assert(delay);\n    assert.deepEqual(log.args, [['debug', '⌛ - Delay service initialized.']]);\n  });\n});\n"],"file":"delay.test.js"}