{"version":3,"sources":["../src/process.test.ts"],"names":["describe","log","sinon","stub","savedProcessName","global","process","title","processListenerStub","exit","exitPromise","fatalErrorDeferred","beforeEach","Promise","resolve","spy","reset","afterEach","done","NODE_ENV","PROCESS_NAME","$instance","destroy","$fatalError","promise","reject","then","catch","test","assert","deepEqual","args","equal","length","YError","find","call","forEach","signal","Knifecycle","register","initProcessService","run"],"mappings":"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","sourcesContent":["import assert from 'assert';\nimport sinon from 'sinon';\nimport YError from 'yerror';\nimport Knifecycle, { constant } from 'knifecycle';\nimport initProcessService from './process';\n\ndescribe('Process service', () => {\n  const log = sinon.stub();\n  const savedProcessName = global.process.title;\n  const processListenerStub = sinon.stub(global.process, 'on');\n  let exit;\n  let exitPromise;\n  let fatalErrorDeferred;\n\n  beforeEach(() => {\n    exitPromise = new Promise((resolve) => {\n      exit = sinon.spy(resolve);\n    });\n    processListenerStub.reset();\n    log.reset();\n  });\n\n  afterEach(() => {\n    global.process.title = savedProcessName;\n  });\n\n  describe('', () => {\n    beforeEach((done) => {\n      initProcessService({\n        NODE_ENV: 'development',\n        PROCESS_NAME: 'Kikooolol',\n        log,\n        exit,\n        $instance: { destroy: () => Promise.resolve() } as Knifecycle,\n        $fatalError: {\n          promise: new Promise((resolve, reject) => {\n            fatalErrorDeferred = { resolve, reject };\n          }),\n        },\n      })\n        .then(() => done())\n        .catch(done);\n    });\n\n    test('should work', () => {\n      assert.deepEqual(\n        log.args,\n        [\n          ['warning', 'ðŸ”‚ - Running in \"development\" environment.'],\n          ['debug', 'ðŸ“‡ - Process service initialized.'],\n        ],\n        'Process initialization information',\n      );\n      assert.equal(global.process.title, 'Kikooolol - development');\n      assert.deepEqual(\n        processListenerStub.args.length,\n        3,\n        'Process fail/signals listened',\n      );\n    });\n\n    test('should handle fatal errors', (done) => {\n      fatalErrorDeferred.reject(new YError('E_AOUCH'));\n\n      exitPromise\n        .then(() => {\n          assert.deepEqual(exit.args, [[1]]);\n        })\n        .then(() => done())\n        .catch(done);\n    });\n\n    test('should handle uncaught exceptions', (done) => {\n      processListenerStub.args.find(\n        (call) => 'uncaughtException' === call[0],\n      )[1](new YError('E_AOUCH'));\n\n      exitPromise\n        .then(() => {\n          assert.deepEqual(exit.args, [[1]]);\n        })\n        .then(() => done())\n        .catch(done);\n    });\n\n    ['SIGINT', 'SIGTERM'].forEach((signal) =>\n      test('should handle `signal`', (done) => {\n        processListenerStub.args.find((call) => signal === call[0])[1](\n          new YError('E_AOUCH'),\n        );\n\n        exitPromise\n          .then(() => {\n            assert.deepEqual(exit.args, [[0]]);\n          })\n          .then(() => done())\n          .catch(done);\n      }),\n    );\n  });\n\n  test('should work with Knifecycle', (done) => {\n    new Knifecycle()\n      .register(initProcessService)\n      .register(constant('log', log))\n      .register(constant('NODE_ENV', 'production'))\n      .register(constant('exit', exit))\n      .run(['process'])\n      .then(() => {\n        assert.deepEqual(log.args, [\n          ['warning', 'ðŸ”‚ - Running in \"production\" environment.'],\n          ['debug', 'ðŸ“‡ - Process service initialized.'],\n        ]);\n      })\n      .then(() => done())\n      .catch(done);\n  });\n});\n"],"file":"process.test.js"}